# Pre-commit hooks aligned with `make check`.
#
# Stages:
# - commit (default): fast autofix + lightweight checks
# - push: full gate equivalent to `make check` (harder to "accidentally" bypass)
# - manual: ad-hoc full runs
#
# Install hooks:
#   uv run pre-commit install
#   uv run pre-commit install --hook-type pre-push
#
# Run everything:
#   uv run pre-commit run --all-files --hook-stage push
#   uv run pre-commit run --all-files --hook-stage manual

minimum_pre_commit_version: "3.6.0"
fail_fast: true
default_stages: [pre-commit]

repos:
  # ----------------------------
  # python -- fast lint/format (commit)
  # ----------------------------
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.14.14
    hooks:
      - id: ruff
        name: python -- ruff check (fix)
        args: [--fix]
        files: ^src/
        stages: [pre-commit]
      - id: ruff-format
        name: python -- ruff format
        files: ^src/
        stages: [pre-commit]

  # ----------------------------
  # JS/TS: fast lint/format (commit)
  # ----------------------------
  - repo: local
    hooks:
      - id: eslint
        name: js- eslint (fix)
        entry: bash -c 'cd client && npx eslint --fix . --ext .js,.jsx,.ts,.tsx'
        language: system
        files: ^client/.*\.(js|jsx|ts|tsx)$
        pass_filenames: false
        stages: [pre-commit]

      - id: prettier
        name: js- prettier (write)
        entry: bash -c 'cd client && npx prettier --write --cache .'
        language: system
        files: ^client/.*\.(js|jsx|ts|tsx|json|css)$
        pass_filenames: false
        stages: [pre-commit]

  # ============================================================
  # FULL QUALITY GATE (push) â€” matches `make check`
  # ============================================================

  # ----------------------------
  # Python lint suite (push)
  # Mirrors Makefile: pylint, flake8, ty, mypy, pydocstyle, prospector
  # ----------------------------
  - repo: local
    hooks:
      - id: ty-check
        name: python- ty check
        entry: uv run ty check --error deprecated src/
        language: system
        files: ^src/.*\.py$
        pass_filenames: false
        stages: [pre-push]

      - id: mypy
        name: python- mypy
        entry: uv run mypy src/
        language: system
        files: ^src/.*\.py$
        pass_filenames: false
        stages: [pre-push]

      - id: pylint
        name: python- pylint
        entry: uv run pylint --rcfile=pyproject.toml src/
        language: system
        files: ^src/.*\.py$
        pass_filenames: false
        stages: [pre-push]

      - id: flake8
        name: python- flake8
        entry: uv run flake8 src/
        language: system
        files: ^src/.*\.py$
        pass_filenames: false
        stages: [pre-push]

      - id: pydocstyle
        name: python- pydocstyle
        entry: uv run pydocstyle src/
        language: system
        files: ^src/.*\.py$
        pass_filenames: false
        stages: [pre-push]

      - id: prospector
        name: python -- prospector
        entry: uv run prospector -A src/
        language: system
        files: ^src/.*\.py$
        pass_filenames: false
        stages: [pre-push]

  # ----------------------------
  # Complexity + architecture (push)
  # Mirrors Makefile: xenon, pycycle
  # ----------------------------
  - repo: local
    hooks:
      - id: xenon
        name: python -- xenon complexity
        entry: uv run xenon --max-absolute A --max-modules A --max-average A src/
        language: system
        files: ^src/.*\.py$
        pass_filenames: false
        stages: [pre-push]

      - id: pycycle
        name: python -- pycycle (circular deps)
        entry: uv run pycycle --here
        language: system
        files: ^src/.*\.py$
        pass_filenames: false
        stages: [pre-push]

  # ----------------------------
  # Dead code (push)
  # Mirrors Makefile: vulture + knip
  # ----------------------------
  - repo: local
    hooks:
      - id: vulture
        name: python -- vulture dead code
        entry: >
          uv run vulture src/
          --min-confidence 60
          --ignore-decorators "@app.get,@app.post,@app.put,@app.patch,@app.delete"
          --ignore-names "stockfish_ponder,move_number,analyze_positions,main,_clear_dashboard_cache,DbSchemas,analysis,insert_tactics,insert_tactic_outcomes,set_level,MockChessClient,MockDbStore,convert_raw_pgns_to_positions,run_monitor_new_positions,clock_seconds,applied_options,is_legal"
        language: system
        files: ^src/.*\.py$
        pass_filenames: false
        stages: [pre-push]

      - id: knip
        name: js -- knip dead code
        entry: bash -c 'cd client && npx knip'
        language: system
        files: ^client/
        pass_filenames: false
        stages: [pre-push]

  # ----------------------------
  # Duplicate code (push)
  # Mirrors Makefile: jscpd
  # ----------------------------
  - repo: local
    hooks:
      - id: jscpd
        name: "dup: jscpd"
        entry: >
          bash -c 'cd client && npx jscpd
          --format python,typescript,tsx,javascript,jsx
          ../src ./src
          --min-lines 8 --min-tokens 70 --threshold 1
          --reporters console
          --ignore "**/dist/**"
          --ignore "**/coverage/**"
          --ignore "**/node_modules/**"
          --ignore "**/.venv/**"
          --ignore "**/tests/**"'
        language: system
        files: \.(py|js|jsx|ts|tsx)$
        pass_filenames: false
        stages: [pre-push]

  # ----------------------------
  # Security / guardrails (push)
  # Mirrors Makefile: safety, bandit, dodgy
  # ----------------------------
  - repo: local
    hooks:
      - id: safety
        name: "sec: safety"
        entry: uv run safety check --full-report
        language: system
        files: ^(pyproject\.toml|uv\.lock|requirements.*\.txt)$
        pass_filenames: false
        stages: [pre-push]

      - id: bandit
        name: "sec: bandit"
        entry: uv run bandit -r src/ -lll
        language: system
        files: ^src/.*\.py$
        pass_filenames: false
        stages: [pre-push]

      - id: dodgy
        name: "sec: dodgy"
        entry: uv run dodgy --max-line-complexity 10 src/
        language: system
        files: ^src/.*\.py$
        pass_filenames: false
        stages: [pre-push]

  # ----------------------------
  # Tests + coverage (push)
  # Mirrors Makefile: pytest/vitest/cargo test
  # ----------------------------
  - repo: local
    hooks:
      - id: pytest
        name: test -- pytest (coverage)
        entry: >
          uv run pytest tests/
          --cov=src/
          --cov-config=./.coveragerc
          --cov-report=term-missing
          --cov-fail-under=95
        language: system
        files: ^(src/.*\.py|tests/.*\.py)$
        pass_filenames: false
        stages: [pre-push]

      - id: vitest
        name: test -- vitest (coverage)
        entry: bash -c 'cd client && npx vitest run --coverage'
        language: system
        files: ^client/
        pass_filenames: false
        stages: [pre-push]

      - id: cargo-test
        name: test -- cargo test
        entry: uv run cargo test
        language: system
        files: \.(rs|toml)$
        pass_filenames: false
        stages: [pre-push]

      - id: cargo-test-release
        name: test -- cargo test --release
        entry: uv run cargo test --release
        language: system
        files: \.(rs|toml)$
        pass_filenames: false
        stages: [pre-push]

  # ----------------------------
  # Builds (push)
  # Mirrors Makefile: cargo build --release + client build
  # ----------------------------
  - repo: local
    hooks:
      - id: cargo-build
        name: "build: cargo build --release"
        entry: uv run cargo build --release
        language: system
        files: \.(rs|toml)$
        pass_filenames: false
        stages: [pre-push]

      - id: client-build
        name: "build: client"
        entry: bash -c 'cd client && npm run build'
        language: system
        files: ^client/
        pass_filenames: false
        stages: [pre-push]